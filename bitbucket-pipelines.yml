pipelines:
  custom:
    build-mavlink-c-library:
      - variables:
          - name: ConanRecipesHash
      - step:
          image: conanio/gcc8
          script:
            - echo "Hash is $ConanRecipesHash"
            - sudo apt-get update && sudo apt-get install -y openssh-client
            - git config --global --add safe.directory /opt/atlassian/pipelines/agent/build
            - git clone git@bitbucket.org:magothyrivertechnologies/conan-recipes.git
            - pushd conan-recipes/mavlink
            - git checkout "$ConanRecipesHash" -b build
            - ./build-source.sh
            - popd
            - rm -fr mavlink
            - cp -r conan-recipes/mavlink/c_library_v2/mavlink .
            - git add mavlink/*
            - git commit --allow-empty -m "autogenerated headers for rev $ConanRecipesHash"
            - git push
